{% extends "base.html" %}
{% block content %}
<div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden md:max-w-2xl transition-colors duration-300">
    <div class="p-8">
        <!-- Flashed Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4" role="alert" aria-live="assertive">
            {% for category, message in messages %}
            <div class="{{ 'bg-green-100 dark:bg-green-900 border-green-500 text-green-700 dark:text-green-300' if category == 'success' else 'bg-red-100 dark:bg-red-900 border-red-500 text-red-700 dark:text-red-300' }} border-l-4 p-4 rounded-lg">
                <p class="font-bold">{{ 'Success' if category == 'success' else 'Error' }}</p>
                <p>{{ message }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <header>
            <h1 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-2">Accessibility Challenge</h1>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6" id="prompt-text">{{ prompt }}</p>
        </header>

        <!-- Captcha Type Navigation -->
        <nav class="flex justify-center mb-6 rounded-lg bg-gray-200 dark:bg-gray-700 p-1" role="tablist" aria-label="Captcha Types">
            <a href="{{ url_for('index', type='audio') }}"
               class="flex-1 text-center py-2 px-4 rounded-md font-medium text-gray-700 dark:text-gray-300 {{ 'captcha-nav-active' if captcha_type == 'audio' else '' }}"
               role="tab" aria-selected="{{ 'true' if captcha_type == 'audio' else 'false' }}">
                Audio Code
            </a>
            <a href="{{ url_for('index', type='riddle') }}"
               class="flex-1 text-center py-2 px-4 rounded-md font-medium text-gray-700 dark:text-gray-300 {{ 'captcha-nav-active' if captcha_type == 'riddle' else '' }}"
               role="tab" aria-selected="{{ 'true' if captcha_type == 'riddle' else 'false' }}">
                Riddle Challenge
            </a>
            <a href="{{ url_for('index', type='timing') }}"
               class="flex-1 text-center py-2 px-4 rounded-md font-medium text-gray-700 dark:text-gray-300 {{ 'captcha-nav-active' if captcha_type == 'timing' else '' }}"
               role="tab" aria-selected="{{ 'true' if captcha_type == 'timing' else 'false' }}">
                Timing Challenge
            </a>
        </nav>

        <!-- Captcha Interaction Area -->
        <div class="captcha-container mb-6">
            {% if captcha_type == 'audio' or captcha_type == 'riddle' %}
            <!-- Play Button for Audio and Riddle -->
            <button id="play-button"
                    class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400 mb-4"
                    aria-label="Play captcha audio">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                Play Sound
            </button>
            {% elif captcha_type == 'timing' %}
            <!-- Audio Player and Play Button for Timing -->
            <audio id="timing-audio" src="{{ url_for('timing_audio') }}" preload="auto" class="hidden"></audio>
            <button id="timing-play-button"
                    class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400 mb-4"
                    aria-label="Play timing challenge audio (one-time listen)">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                Play Challenge (1 Listen)
            </button>
            {% endif %}

            <!-- Submission Form -->
            <form id="captcha-form" action="{{ url_for('validate') }}" method="POST">

                {% if captcha_type != 'timing' %}
                <!-- Text Input for Audio and Riddle (name="captcha_input") -->
                <div>
                    <label for="captcha-input-text" class="sr-only">Enter your answer</label>
                    <input type="text" id="captcha-input-text" name="captcha_input"
                           class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-lg p-3 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                           placeholder="Type your answer here..."
                           aria-describedby="prompt-text"
                           autofocus>
                </div>
                {% else %}
                <!-- Hidden Input for Timing (name="captcha_input") -->
                <input type="hidden" id="captcha-input-timing" name="captcha_input">
                <!-- Visual feedback for timing captcha -->
                <div class="w-full h-24 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center" aria-hidden="true">
                    <span id="timing-feedback" class="text-gray-500 dark:text-gray-400 font-medium">Press Play, then listen and hold SPACEBAR...</span>
                </div>
                {% endif %}

                <!-- Submit Button -->
                {% if captcha_type != 'timing' %}
                <button id="submit-button" type="submit"
                        class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-400 mt-4">
                    Submit Answer
                </button>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const captchaType = '{{ captcha_type }}';
        const spokenText = '{{ spoken_text|safe }}';
        const captchaForm = document.getElementById('captcha-form');

        // --- Logic for Audio and Riddle Captchas ---
        if (captchaType === 'audio' || captchaType === 'riddle') {
            const playButton = document.getElementById('play-button');
            const textInput = document.getElementById('captcha-input-text'); // Get text input

            playButton.addEventListener('click', function () {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(spokenText);
                    utterance.onerror = function(event) {
                        console.error('Speech synthesis error:', event.error);
                        alert('Error: Could not play audio. Please check your browser/system audio settings.');
                    };
                    window.speechSynthesis.cancel(); // Clear queue
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Your browser does not support text-to-speech. Please try a different browser.');
                }
            });

            // Focus the text input when this captcha is active
            if (textInput) {
                textInput.focus();
            }
        }

        // --- Logic for Timing Captcha ---
        if (captchaType === 'timing') {
            const playButton = document.getElementById('timing-play-button');
            const audio = document.getElementById('timing-audio');
            const feedback = document.getElementById('timing-feedback');
            const timingInput = document.getElementById('captcha-input-timing'); // Get hidden input

            let isHolding = false;
            let startTime = 0;
            let intervals = [];

            playButton.addEventListener('click', function () {
                audio.play();
                playButton.disabled = true; // Disable after one click
                playButton.classList.add('opacity-50', 'cursor-not-allowed');
                playButton.innerText = 'Listening...';
                feedback.innerText = 'Listening... Hold SPACEBAR for sounds.';

                // Set focus to the body to capture key events
                document.body.focus();
            });

            // Auto-submit when audio finishes
            audio.addEventListener('ended', function() {
                feedback.innerText = 'Submitting response...';
                // Finalize intervals just in case spacebar is still held
                if (isHolding) {
                    const endTime = audio.currentTime;
                    intervals.push([startTime, endTime]);
                    isHolding = false;
                }

                if (timingInput) {
                    timingInput.value = JSON.stringify(intervals);
                }

                // Add a small delay for user to see feedback, then submit
                setTimeout(() => {
                    captchaForm.submit();
                }, 500);
            });

            audio.addEventListener('error', function(e) {
                console.error('Audio playback error:', e);
                feedback.innerText = 'Error loading audio. Please try again.';
                playButton.disabled = false;
                playButton.classList.remove('opacity-50', 'cursor-not-allowed');
                playButton.innerText = 'Play Challenge (1 Listen)';
            });

            document.addEventListener('keydown', function (e) {
                if (e.code === 'Space' && !isHolding && audio.paused === false) {
                    e.preventDefault(); // Prevent page scroll
                    isHolding = true;
                    startTime = audio.currentTime;
                    if (feedback) {
                        feedback.style.backgroundColor = '#10B981'; // green-500
                        feedback.style.color = 'white';
                        feedback.innerText = 'Sound Detected!';
                    }
                }
            });

            document.addEventListener('keyup', function (e) {
                if (e.code === 'Space' && isHolding) {
                    e.preventDefault();
                    isHolding = false;
                    const endTime = audio.currentTime;
                    intervals.push([startTime, endTime]);
                    if (feedback) {
                        feedback.style.backgroundColor = ''; // Reset
                        feedback.style.color = '';
                        feedback.innerText = 'Listening...';
                    }
                }
            });
        }
    });
</script>
{% endblock %}